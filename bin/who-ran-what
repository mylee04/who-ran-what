#!/bin/bash

# who-ran-what - Track your AI agent and skill usage
# https://github.com/mylee04/who-ran-what

set -e

# Version
VERSION="0.2.1"

# Determine the directory where the script is located (resolve symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib/who-ran-what"

# Load utility functions
source "$LIB_DIR/utils/colors.sh"
source "$LIB_DIR/utils/errors.sh"
source "$LIB_DIR/utils/detect.sh"
source "$LIB_DIR/utils/config.sh"
source "$LIB_DIR/core/claude-parser.sh"
source "$LIB_DIR/core/gemini-parser.sh"
source "$LIB_DIR/core/codex-parser.sh"
source "$LIB_DIR/core/opencode-parser.sh"
source "$LIB_DIR/core/display.sh"
source "$LIB_DIR/core/json-output.sh"
source "$LIB_DIR/core/share.sh"
source "$LIB_DIR/core/tips.sh"

# Detect how the script was called
COMMAND_NAME=$(basename "$0")

# Parse global flags
export JSON_OUTPUT="false"
declare -a REMAINING_ARGS

parse_global_flags() {
    REMAINING_ARGS=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --json|-j)
                JSON_OUTPUT="true"
                shift
                ;;
            *)
                REMAINING_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

# Show version
show_version() {
    echo "who-ran-what version $VERSION"
}

# Show help
show_help() {
    cat << 'EOF'
who-ran-what - Track your AI agent and skill usage

USAGE:
    who-ran-what [options] <command>
    wr [options] <command>    # Short alias
    wrp <command>             # Project command alias

OPTIONS:
    --json, -j      Output in JSON format

COMMANDS:
    (default)       Show dashboard overview
    today           Today's usage
    week            This week's usage
    month           This month's usage
    agents          Agent breakdown
    skills          Skill breakdown
    projects        Project breakdown
    gemini          Gemini CLI tool usage
    codex           Codex CLI tool usage
    opencode        OpenCode tool usage
    share           Generate shareable stats image
    tips            Get tips to improve your workflow
    clean           Show unused agents/skills
    config          Show current configuration
    help            Show this help message
    version         Show version information

PROJECT COMMANDS:
    project         Show current project stats (or: wrp)

EXAMPLES:
    wr              # Show dashboard
    wr week         # Weekly breakdown
    wr agents       # Agent usage stats
    wr --json       # Dashboard in JSON
    wr agents -j    # Agents in JSON
    wrp             # Current project stats

MORE INFO:
    https://github.com/mylee04/who-ran-what
EOF
}

# Handle common commands (shared between wr and who-ran-what)
handle_command() {
    local cmd="${1:-dashboard}"

    case "$cmd" in
        "help"|"-h"|"--help")
            show_help
            ;;
        "version"|"-v"|"--version")
            show_version
            ;;
        "today"|"week"|"month"|"agents"|"skills"|"projects"|"clean"|"dashboard"|"gemini"|"codex"|"opencode")
            source "$LIB_DIR/commands/stats.sh"
            handle_stats_command "$@"
            ;;
        "share")
            shift
            handle_share_command "$@"
            ;;
        "tips")
            shift
            handle_tips_command "$@"
            ;;
        "project")
            shift
            source "$LIB_DIR/commands/project.sh"
            handle_project_command "$@"
            ;;
        "config")
            show_config
            ;;
        *)
            error "Unknown command: $cmd"
            echo "Try '$COMMAND_NAME help' for usage"
            exit 1
            ;;
    esac
}

# Main command router
main() {
    parse_global_flags "$@"
    set -- "${REMAINING_ARGS[@]}"

    case "$COMMAND_NAME" in
        "wrp")
            source "$LIB_DIR/commands/project.sh"
            handle_project_command "$@"
            ;;
        *)
            handle_command "$@"
            ;;
    esac
}

main "$@"
